var app = angular.module('qmgj_unlogin', ['ui.router','ui.bootstrap']);
app.config(['$stateProvider', '$urlRouterProvider',
    function($stateProvider, $urlRouterProvider) {
        $urlRouterProvider.otherwise('/login');
        $stateProvider.state('home', {
            url: '/home',
            templateUrl: 'static/app/view/homeView.html',
            // 控制器的名字 不是js文件名
            controller: 'homeController'
        }).state('reg',{
        	// 注册
        	url:'/reg',
        	templateUrl:'static/app/view/regView.html',
        	controller:'regController'
        }).state('login',{
        	// 登录
        	url:'/login',
        	templateUrl:'static/app/view/loginView.html',
        	controller:'loginController'
        }).state('list', {
            // 列表页
            url: '/list',
            templateUrl: 'static/app/view/listView.html',
            controller: 'listController'
        }).state('list2', {
            // 列表页 传递参数 搜索框进入列表
            url: '/list/:keyword',
            templateUrl: 'static/app/view/listView.html',
            controller: 'listController'
        })
    }
]);
app.filter('substr', function() {
    return function() {
        var val = arguments[0],
            start = arguments[1],
            count = arguments[2];
        if (start == undefined) {
            start = 0;
            count = val.length;
        }
        // substr:15
        if (count == undefined) {
            start = 0;
            count = arguments[1];
        }
        return val.substr(start, count);
    }
})

var app2 = angular.module('qmgj_login', ['ui.router', 'ui.bootstrap']);
app2.config(['$stateProvider', '$urlRouterProvider',
    function($stateProvider, $urlRouterProvider) {
        $urlRouterProvider.otherwise('/vip/main');
        $stateProvider.state('home', {
            url: '/home',
            templateUrl: 'static/app/view/homeView.html',
            controller: 'homeController'
        }).state('vip', {
            // 个人中心页
            url: '/vip',
            templateUrl: 'static/app/view/vipView.html',
            controller: 'vipController'
        }).state('vip.main', {
            // 个人主页
            url: '/main',
            templateUrl: 'static/app/view/vip.mainView.html',
            controller: 'vipMainController'
        }).state('vip.info', {
            // 个人信息页
            url: '/info',
            templateUrl: 'static/app/view/vip.infoView.html',
            controller: 'vipInfoController'
        }).state('vip.record', {
            //购买记录
            url: '/record',
            templateUrl: 'static/app/view/vip.recordView.html',
            controller: 'vipRecordController'
        }).state('list', {
            // 列表页
            url: '/list',
            templateUrl: 'static/app/view/listView.html',
            controller: 'listController'
        }).state('list2', {
            // 列表页 传递参数 搜索框进入列表
            url: '/list/:keyword',
            templateUrl: 'static/app/view/listView.html',
            controller: 'listController'
        })
    }
]);

app2.controller('logoutController', ['$scope', '$http', function($scope, $http) {
    $scope.userLogout = function() {
        $http({
            url: '/user/logout',
        }).then(function(res) {
            if (res.data.resultCode == '0000') {
                alert('退出成功');
                location.reload();
            }
        })
    }
}]);

// substr过滤
app2.filter('substr', function() {
    return function() {
        var val = arguments[0],
            start = arguments[1],
            count = arguments[2];
        if (start == undefined) {
            start = 0;
            count = val.length;
        }
        // substr:15
        if (count == undefined) {
            start = 0;
            count = arguments[1];
        }
        return val.substr(start, count);
    }
});

// 通过时间毫秒获取上下午
app2.filter('getMoon', function() {
    return function(input) {
        var curH = new Date(parseInt(input)).getHours();
        var moon = '';
        if (6 < curH && curH < 12) {
            moon = "上午";
        } else if (12 <= curH && curH < 14) {
            moon = "中午";
        } else if (curH >= 14 && curH < 18) {
            moon = "下午";
        } else if (curH >= 18 && curH < 24) {
            moon = "晚上";
        } else {
            moon = "凌晨";
        }
        return moon;
    }

});

app.controller('homeController', ['$scope', '$http', '$interval', myHomeController]);
app2.controller('homeController', ['$scope', '$http', '$interval', myHomeController]);

function myHomeController($scope, $http, $interval) {
    $scope.hotNav = ['', '微电影', '电视剧', '话剧', '电影', '戏曲', '书画', '相声', '戏剧', '音乐剧'];
    var HomePage = {
        init: function() {
            var that = this;
            $http({
                url: '/IndexInfo',
                method: 'get'
            }).then(function(res) {
                console.log(res);
                if (res.data.resultCode == '0000') {
                    // 轮播图数据
                    that.dealSlide(res.data.result.slides);
                    // 热门数据
                    that.dealHot(res.data.result.hot);
                    // 卫视主推
                    that.dealTV(res.data.result.new);
                    // 合作单位
                    that.dealUnit(res.data.result.unit);
                } else {
                    alert(res.data.resultMsg);
                }
            })
        },
        dealSlide: function(slideData) {
            // 轮播图处理
            $scope.slideData = slideData;
            $scope.showIndex = 0;
            var inter = $interval(function() {
                $scope.showIndex++;
                if ($scope.showIndex == $scope.slideData.length) {
                    $scope.showIndex = 0;
                }
            }, 1500);
            $scope.pauseSlide = function(index) {
                $interval.cancel(inter);
                $scope.showIndex = index;
            }
            $scope.playSlide = function() {
                inter = $interval(function() {
                    $scope.showIndex++;
                    if ($scope.showIndex == $scope.slideData.length) {
                        $scope.showIndex = 0;
                    }
                }, 1500);
            }
        },
        dealHot: function(hotData) {
            // 热门数据
            $scope.hotData = hotData;
            $scope.hotItem = hotData[0];
            $scope.hotIndex = 0;
            $scope.showHotItem = function(index) {
                $scope.hotIndex = index;
                $scope.hotItem = hotData[index];
            };
        },
        dealTV: function(tvData) {
            $scope.tvData = tvData;
        },
        dealUnit: function(unitData) {
            $scope.unitData = unitData;
        }
    };
    HomePage.init();

}

app.controller('listController', ['$scope', '$http','$stateParams', myListController]);
app2.controller('listController', ['$scope', '$http','$stateParams', myListController]);

function myListController($scope, $http,$stateParams) {
    var arr = ['全部', '微电影', '电视剧', '话剧', '电影', '戏曲', '书画', '相声', '戏剧', '音乐剧', '其它'];
    $scope.arr = arr;
    var s = ['筹资中', '已结束', '成功'];
    $scope.s = s;
    var t = ['最新', '热门', '结束时间'];
    $scope.t = t;

    var List = {

        init: function() {
            var that = this;
            // 0 全部    1 第一页   5每页五条数据
            $scope.countAll = 0;
            $scope.type = 0; // 0全部	1未支付 	2已支付 
            $scope.page = 1;
            $scope.cid = 0;
            $scope.status = 0;
            $scope.timeStatus = 0;
            $scope.count = 9;
            $scope.maxSize = 5; //显示多少也签

            $scope.keyword = '';
            //
            if($stateParams.keyword != undefined ){
                $scope.keyword = $stateParams.keyword;
            }

            that.events();
            that.getListData();
        },
        events: function() {
            var that = this;
            $scope.pageChanged = function() {
                console.log($scope.page);
                that.getListData();
            };
            $scope.changeType = function(index) {
                $scope.cid = index;
                that.getListData();
            };
            $scope.changeStatus = function(index) {
                $scope.status = index;
                that.getListData();
            };
            $scope.changeTimeStatus = function(index) {
                $scope.timeStatus = index;
                that.getListData();
            };
        },
        getListData: function() {
            $http({
                url: '/prolist',
                method: 'get',
                params: {
                    keyword: $scope.keyword, // 关键字搜索， 选填
                    cid: $scope.cid, // 数组下标 ['全部','微电影','电视剧','话剧','电影','戏曲','书画','相声','戏剧','音乐剧','其它']
                    status: $scope.status, // 0 筹资中  1已结束  2成功
                    timeStatus: $scope.timeStatus, // 0最新  1热门  2结束时间
                    page: $scope.page, // 第1页数据  默认第1页
                    count: $scope.count // 一页9条数据
                }
            }).then(function(res) {
                if (res.data.resultCode == '0000') {
                    var result = res.data.result;
                    $scope.countAll = result.countAll;
                    $scope.lists = result.list;
                } else {
                    alert(res.data.resultMsg);
                }

            })
        }
    };
    List.init();
}

app.controller('loginController',['$scope','$http','$state',function($scope,$http,$state){
	
	$scope.loginClick = function(){
		if($scope.myform.$valid){
			$http({
				url:'/user/login',
				method:'post',
				data:{
					phone:$scope.phone,
					password:$scope.pwd				
				}
			}).then(function(res){
				// console.log(res);
				if(res.data.resultCode == '0000'){
					alert('登录成功');				
					location.reload();
				}else{
					alert(res.data.resultMsg);
				}
			})
		}
	}
}])
app.controller('regController',['$scope','$http','$state',function($scope,$http){
	$scope.regClick = function(){
		if($scope.myform.$valid && $scope.pwd == $scope.newPwd){
			$http({
				url:'/user/reg',
				method:'post',
				data:{
					name:$scope.username,
					phone:$scope.phone,
					password:$scope.pwd,
					passwordRepeat:$scope.newPwd,
				}
			}).then(function(res){
				// console.log(res);
				if(res.data.resultCode == '0000'){
					alert('注册成功');
					$state.go('login')
				}else{
					alert(res.data.resultMsg);
				}
			})
		}
	}
}])
app.controller('searchController',['$scope','$http',function($scope,$http){
	
}]);
app2.controller('searchController',['$scope','$http',function($scope,$http){
	
}]);
app2.controller('vipController',['$scope','$http','$rootScope',
	function($scope,$http,$rootScope){
	$http({
		url:'/user/info',
		method:'post'
	}).then(function(res){
		$scope.userinfo = res.data.result;
		// console.log($scope.userinfo);

	});
	

}])
app2.controller('vipInfoController',['$scope',function($scope){
	$scope.cipArr = ['微电影','电视剧','话剧','电影','戏曲','书画','相声','戏剧','音乐剧'];
	$scope.fileNameChanged = function(event){
		console.log(event);
	}
	$scope.checkbox = function(e){// e 事件
		// console.log(e.target);
		var ngDom = angular.element(e.target);
		ngDom.toggleClass('active');

	}
	$scope.radio = function(e){
		var ngDom = angular.element(e.target);
		ngDom.parent().children().removeClass('active');
		ngDom.addClass('active');
	}
	$scope.submit = function(){
		var ngDom1 = angular.element(document.querySelectorAll('.info-radio.active'));
		console.log('性别',ngDom1.attr('data-value'));
		var ngDom2 = angular.element(document.querySelectorAll('.info-checkbox.active'));
		var arr = [];
		for (var i = 0; i < ngDom2.length; i++) {
			arr.push(ngDom2.eq(i).attr('data-value'));
		}
		console.log('关注的圈子',arr.toString());
	}
}])
app2.controller('vipMainController',['$scope','$http',function($scope,$http){
	$http({
		url:'/user/pros',
		method:'get'
	}).then(function(res){
		$scope.procare = res.data.result.procare;
		$scope.prohot = res.data.result.prohot;

	})
}])
app2.controller('vipRecordController',['$scope','$http',function($scope,$http){
	var Record = {
		init:function(){
			var that = this;			
			// 0 全部    1 第一页   5每页五条数据
			$scope.countAll = 0;
			$scope.type = 0;// 0全部	1未支付 	2已支付 
			$scope.page = 1;
			$scope.count = 6;
			$scope.maxSize = 5;//显示多少也签

			that.events();
			that.getRecordData();			
		},
		events:function(){
			var that = this;
			$scope.pageChanged = function(){
				// console.log($scope.pageChanged);
				that.getRecordData();
			};
			$scope.changeType = function(index){
				$scope.type = index;
				that.getRecordData();
			}

		},
		getRecordData:function(){
			$http({
				url:'/user/RecordList',
				method:'post',
				data:{
					type:$scope.type,
					page:$scope.page,
					count:$scope.count
				}
			}).then(function(res){
				if(res.data.resultCode == '0000'){
					// console.log(res);
					var result = res.data.result;
					$scope.countAll = result.count;
					$scope.recordData = result.list;					
				}else{
					alert(res.data.resultMsg);
				}
			})
		}
	};
	Record.init();
}])